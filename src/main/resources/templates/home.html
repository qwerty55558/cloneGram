<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Home</title>
    <th:block th:fragment="header">
    <!--  BootStrap5  -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!--  FontAwesome  -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!--  QuillCss-->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.3/dist/quill.snow.css" rel="stylesheet">
    </th:block>

    <style>
    .side-bar-left{
        min-width: 20px;
        max-width: 200px;
        border-right: 1px solid darkslategray;
        background: black;
    }

    .main-content-center{
        background: black;
        color: white;
        width: 100%;
        overflow-y: auto;

        display: flex; /* Flexbox 레이아웃 사용 */
        justify-content: center; /* 수평 가운데 정렬 */
        align-items: flex-start ; /* 수직 가운데 정렬 */
        height: 100vh; /* 화면 전체 높이를 차지하도록 설정 */
    }
    .main-content-center::-webkit-scrollbar {
        display: none;
    }
    .profileitem::-webkit-scrollbar{
        display: none;
    }

    .side-bar-right{
        width: 400px;
        max-width: 100%;
        background: black;
        border-left: 1px solid darkslategray;
        align-content: center;
        color: white;

        display: flex;
        justify-content: center;
        align-items: flex-start; /* 수직 시작 위치*/
        height: 100vh;
    }

    .navbtn {
        outline-style: hidden;
        border: hidden;
        font-size: x-large;
        text-align: left;

        overflow: hidden;
        white-space: nowrap;
    }

    .profilebtn{
        outline-style: hidden;
        font-size: medium;
        text-align: center;
        text-overflow: fade;
        overflow: hidden;
        word-wrap: break-word;
    }


    .nav-item-text{
        color: white;
        text-decoration: none; /* 밑줄 제거 */
    }

    .panels{
        width: 80%;
        height: 100vh;
        display: flex;
    }

    .profileitem{
        margin: auto;
        padding: 5px;
        font-size: large;
        word-break: keep-all;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    @media(max-width: 900px){
        .side-bar-right{
            display: none;
        }
    }

    @media (max-width: 600px) {
        .btnText{
            display: none;
        }
        .navbtn{
            text-align: center;
        }
        .nav-item{
            display: none;
        }
        .nav-item-text{
            display: block;
            text-align: center;
        }
        .picpanel{
            padding-top: 450px;
        }
        .postimage{
            height: 300px;
        }

    }

    @media (min-width: 601px) {
        .nav-item{
            display: block;
        }
        .nav-item-text {
            display: none;
        }
        .picpanel{
            padding-top: 150px;
        }
        .postimage{
            height: 250px;
        }
    }

    </style>
</head>
<body>
<!-- html data -->
<section class="vh-100 d-flex justify-content-between">
    <div class="side-bar-left">
        <div class="nav flex-column nav-pills mx-3 vh-100" id="v-pills-tab" role="tablist" aria-orientation="vertical">
            <a class="nav-item" th:href="@{/home}"><img src="/images/logo.webp" style="max-width: 100%" alt=""></a>
            <a class="nav-item-text" th:href="@{/home}"><i class="fa-brands fa-instagram fa-3x me-3"></i></a>
            <button class="btn btn-outline-dark navbtn text-white active" id="v-pills-home-tab" data-bs-toggle="pill" data-bs-target="#v-pills-home" type="button" role="tab" aria-controls="v-pills-home" aria-selected="true"><i class="fa-solid fa-house me-3"></i><span class="btnText">홈</span></button>
            <button class="btn btn-outline-dark navbtn text-white" id="v-pills-who-tab" data-bs-toggle="pill" data-bs-target="#v-pills-who" type="button" role="tab" aria-controls="v-pills-who" aria-selected="false"><i class="fa-solid fa-magnifying-glass me-3"></i><span class="btnText">검색</span></button>
            <button class="btn btn-outline-dark navbtn text-white" id="v-pills-search-tab" data-bs-toggle="pill" data-bs-target="#v-pills-search" type="button" role="tab" aria-controls="v-pills-search" aria-selected="false"><i class="fa-solid fa-compass me-3"></i><span class="btnText">탐색 탭</span></button>
            <button class="btn btn-outline-dark navbtn text-white" id="v-pills-video-tab" data-bs-toggle="pill" data-bs-target="#v-pills-video" type="button" role="tab" aria-controls="v-pills-video" aria-selected="false"><i class="fa-solid fa-camera-retro me-3"></i><span class="btnText">릴스</span></button>
            <button class="btn btn-outline-dark navbtn text-white" id="v-pills-message-tab" data-bs-toggle="pill" data-bs-target="#v-pills-message" type="button" role="tab" aria-controls="v-pills-message" aria-selected="false"><i class="fa-solid fa-location-arrow me-3"></i><span class="btnText">메시지</span></button>
            <button class="btn btn-outline-dark navbtn text-white" id="v-pills-likey-tab" data-bs-toggle="pill" data-bs-target="#v-pills-likey" type="button" role="tab" aria-controls="v-pills-likey" aria-selected="false"><i class="fa-regular fa-heart me-3"></i><span class="btnText">알림</span></button>
            <button class="btn btn-outline-dark navbtn text-white" id="v-pills-create-tab" data-bs-toggle="pill" data-bs-target="#v-pills-create" type="button" role="tab" aria-controls="v-pills-create" aria-selected="false"><i class="fa-regular fa-square-plus me-3"></i><span class="btnText">만들기</span></button>
            <button class="btn btn-outline-dark navbtn text-white" id="v-pills-profile-tab" data-bs-toggle="pill" data-bs-target="#v-pills-profile" type="button" role="tab" aria-controls="v-pills-profile" aria-selected="false"><img class="me-3" th:src="${picurl.miniPic}" style="width: 35px; height: 35px; object-fit: cover;border-radius: 70%;"><span class="btnText">프로필</span></button>
            <div class="btn-group dropup mt-auto mb-3">
<!--                <button class="btn btn-outline-dark navbtn text-white mt-auto mb-3" type="button"><i class="fa-solid fa-bars me-3" ></i><span class="btnText">더 보기</span></button>-->
                <button class="btn btn-outline-dark navbtn text-white dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" type="button"><i class="fa-solid fa-bars me-3" ></i><span class="btnText">더 보기</span></button>
                <ul class="dropdown-menu" style="background: black;border: 1px darkslategray solid">
                    <li><a class="dropdown-item" href="/logout" style="text-decoration: none;color: white">로그아웃</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="main-content-center tab-content" id="v-pills-tabContent">
        <div class="tab tab-pane fade panels show active " id="v-pills-home" role="tabpanel" aria-labelledby="v-pills-home-tab" tabindex="0" aria-orientation="horizontal" >
            <div class="follow-bar my-3">
                qwer
            </div>
            <div class="content-panel">
                panel
            </div>
        </div>
        <div class="tab tab-pane fade panels" id="v-pills-profile" role="tabpanel" aria-labelledby="v-pills-profile-tab" tabindex="1" aria-orientation="horizontal">
            <div class="row pt-5" style="width:100%;height: 30%">
                <div class="col-xl-4 col-lg-5 col-md-6 col-sm-6 ">
                    <img th:src="${picurl.profilePic}" style="border-radius: 70%;width: 80%">
                </div>
                <div class="col-xl-8 col-lg-7 col-md-6 col-sm-6">
                    <div class="col-4 pt-4" style="width: 100%">
                        <div class="row">
                            <div class="col-3 profileitem" style="font-weight: bold;font-size: larger" th:text="${user.getUserName()}"></div>
                            <div class="col-4 profileitem"><button class="btn btn-outline-dark profilebtn text-white" onclick="goToProfileEditPage()">프로필 편집</button></div>
                            <div class="col-4 profileitem"><button class="btn btn-outline-dark profilebtn text-white">보관된 스토리 보기</button> </div>
                            <div class="col-1 profileitem"><i class="fa-solid fa-gear fa-lg"></i></div>
                        </div>
                    </div>
                    <div class="col-4" style="width: 100%">
                        <div class="row">
                            <div class="col-1"></div>
                            <div class="col-3 profileitem" th:text="'게시물 '+${posts.size()}">게시물</div>
                            <div class="col-4 profileitem"><a id="followercount" href="#" data-bs-toggle="modal" data-bs-target="#followermodal" style="color: white;text-decoration: none" th:text="'팔로워 '+${follow.getFollower()}"></a>
                                <!-- Modal -->
                                <div class="modal fade" id="followermodal" tabindex="-1" aria-labelledby="followermodalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content" style="background: black">
                                            <div class="modal-header justify-content-between">
                                                <h1 class="modal-title fs-5" id="followermodalLabel">팔로워 목록</h1>
                                                <a href="#" style="color: white;text-decoration: none" data-bs-dismiss="modal" aria-label="Close"><i class="fa-solid fa-window-close fa-xl"></i></a>
                                            </div>
                                            <div id="followerList" class="modal-body">

                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Modal -->
                            </div>
                            <div class="col-4 profileitem"><a id="followingcount" href="#" data-bs-toggle="modal" data-bs-target="#followingmodal" style="color: white;text-decoration: none" th:text="'팔로잉 '+${follow.getFollowing()}" ></a>
                                <!-- Modal -->
                                <div class="modal fade" id="followingmodal" tabindex="-1" aria-labelledby="followingmodalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content" style="background: black">
                                            <div class="modal-header justify-content-between">
                                                <h1 class="modal-title fs-5" id="followingmodalLabel">팔로잉 목록</h1>
                                                <a href="#" style="color: white;text-decoration: none" data-bs-dismiss="modal" aria-label="Close"><i class="fa-solid fa-window-close fa-xl"></i></a>
                                            </div>
                                            <div id="followingList" class="modal-body">

                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Modal -->
                            </div>
                            <div class="col-1"></div>
                        </div>
                    </div>
                    <div class="col-4 pt-4" style="width: 100%">
                        <div class="row profileitem" style="font-weight: bold" th:text="${user.getFullName()}">

                        </div>
                        <div class="row profileitem" style="height: 100px; overflow: scroll" th:text="${user.getBio()}">

                        </div>
                    </div>
                </div>
            </div>
            <div class="row picpanel" style="width:100%;">
                <div class="col-xxl-4 col-md-6 my-3" th:each="post : ${posts}">
                    <a th:href="@{'/post?id='+${post.getId()}}"><img class="postimage" th:src="${post.getImageUrl()}" style="border-radius: 20%;width: auto;" alt=""></a>
                </div>
            </div>
        </div>
        <div class="tab tab-pane fade panels" id="v-pills-create" role="tabpanel" aria-labelledby="v-pills-create-tab" tabindex="2" aria-orientation="horizontal">
            <div class="pan" style="width: 100%;display: flex;justify-content: center;align-content: start">
                <div class="card text-center mt-5" style="width: 60%;min-width: 250px">
                    <div class="card-header text-white" style="background: darkslategray;">
                        만들기
                    </div>
                    <div class="card-body text-white" style="background: black">
                        <h5 id="hiddenTitle" class="card-title">피드 작성을 위한 사진을 등록해주세요.</h5>
                        <input type="file" id="postPicInput" accept="image/*">
                        <img id="postPicImg" hidden="hidden" style="width: 200px;height: 200px">
                        <p></p>
                        <button type="button" id="postPicDeleteBtn" class="btn btn-outline-dark profilebtn text-white" hidden="hidden" style="justify-content: end">사진 삭제</button>
                    </div>
                    <div class="card-footer text-center text-white" style="background: black;border-top: darkslategray;border-style: solid;height: fit-content;border-width: 1px">
                        <div id="editor"></div>
                    </div>
                </div>
            </div>
            <div class="pan" style="width: 100%;display: flex;justify-content: center;align-content: start">
                <div class="minipan" style="width: 60%;min-width: 200px"></div>
                <a href="#!" onclick="fetchPostData()" class="mt-2 me-3" style="justify-content: end;text-decoration: none;color: white"><i class="fa-solid fa-arrow-right fa-lg"></i></a>
            </div>
        </div>
        <div class="tab tab-pane fade panels" id="v-pills-who" role="tabpanel" aria-labelledby="v-pills-who-tab" tabindex="3" aria-orientation="horizontal">
            <div class="pan" style="width: 100%;display: flex;justify-content: center;align-content: start">
                <div id="searchbar"></div>
            </div>
        </div>
    </div>
    <div class="side-bar-right">
        qwer
    </div>
</section>

<!-- html data-->
<th:block th:fragment="footer">
<!-- BootStrap5 js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<!-- jquery -->
<script  src="https://code.jquery.com/jquery-latest.min.js"></script>
<!-- quill editor-->
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.3/dist/quill.js"></script>

</th:block>
<script th:inline="javascript">
    const maxSize = 1024 * 1024;
    const captionSize = 500;
    let quill;
    let squill;
    function goToProfileEditPage() {
        window.location.href = /*[[@{/profile/edit}]]*/ "";
    }

    $(document).ready(function () {
        // 파라미터 확인
        let searchParams = new URLSearchParams(window.location.search);
        if (searchParams !== null) {
            // tap 파라미터 확인해서 어느 탭을 되돌려 보낼건지 확인
            let enableTab = searchParams.get('tab');
            if (enableTab === 'profile') {
                // 탭 활성화 로직
                $('#v-pills-home-tab').removeClass('active').attr('aria-selected', 'false');
                $('#v-pills-profile-tab').addClass('active').attr('aria-selected', 'true');
                $('#v-pills-home').removeClass('show').removeClass('active');
                $('#v-pills-profile').addClass('show').addClass('active');
            }

        }
        // editor quill
        const option = {
            theme: 'snow',
            modules:{
                toolbar: false
            }
        }
        quill = new Quill('#editor',option);
        squill = new Quill('#searchbar', option);


        // file upload
        $('#postPicInput').on('change',function () {
            let selectedFile = $(this)[0].files[0];
            if (selectedFile) {
                // 선택된 파일이 있을 경우
                let reader = new FileReader();
                reader.onload = function(event) {
                    // 파일을 읽어서 base64 URL로 변환
                    let imageUrl = event.target.result;
                    // hidden 이미지의 src 속성에 설정, hidden 속성 제거
                    $('#postPicImg').attr('src', imageUrl).removeAttr('hidden');
                    $('#hiddenTitle').attr('hidden', 'hidden');
                    $('#postPicInput').attr('hidden', 'hidden');
                    $('#postPicDeleteBtn').removeAttr('hidden');
                };
                reader.readAsDataURL(selectedFile);
            }
        });

        $('#followermodal').on('show.bs.modal', function (e) {
            $.ajax({
                url: '/find/myfollower',
                method: 'GET',
                success: function(response) {
                    // 서버로부터 받은 데이터를 사용하여 follower 목록을 구성합니다.
                    let followerList = response; // 팔로워 목록 데이터
                    let $followerList = $('#followerList');
                    $followerList.empty(); // 이전에 표시된 follower 목록을 비웁니다.
                    followerList.forEach(function(follower) {
                        $followerList.append('<div class="follower-item"><a style="color: white;text-decoration: none" href="profile?id='+follower.userId+'">'+
                            '<img class="mx-2" src="' + follower.userPic + '" style="border-radius: 70%">' +
                            '<span>' + follower.userName + '</span></a>' +
                            '</div>');
                    });
                },
                error: function(xhr, status, error) {
                    console.error('AJAX 오류:', status, error);
                }
            });
        });

        $('#followingmodal').on('show.bs.modal', function (e) {
            $.ajax({
                url: '/find/myfollowing',
                method: 'GET',
                success: function(response) {
                    // 서버로부터 받은 데이터를 사용하여 follower 목록을 구성합니다.
                    let followingList = response; // 팔로워 목록 데이터
                    let $followingList = $('#followingList');
                    $followingList.empty(); // 이전에 표시된 follower 목록을 비웁니다.
                    followingList.forEach(function(following) {
                        $followingList.append('<div class="following-item"><a style="color: white;text-decoration: none" href="profile?id='+following.userId+'">'+
                            '<img class="mx-2" src="' + following.userPic + '" style="border-radius: 70%">' +
                            '<span>' + following.userName + '</span></a>' +
                            '</div>');
                    });
                },
                error: function(xhr, status, error) {
                    console.error('AJAX 오류:', status, error);
                }
            });
        });

    })
    // document.ready



    $('#postPicDeleteBtn').click(function () {
        $('#postPicImg').attr('hidden','hidden');
        $('#hiddenTitle').removeAttr('hidden');
        $('#postPicInput').removeAttr('hidden').val('');
        $('#postPicDeleteBtn').attr('hidden','hidden');
    });

    function fetchPostData() {
        let formData = new FormData();
        let fileInput = document.getElementById("postPicInput");
        let file = fileInput.files[0];
        if (file.size > maxSize) {
            const image = new Image();
            image.src = URL.createObjectURL(file);
            image.onload = function() {
                const downsampledFile = downsampleImage(image, 500, 500);
                formData.append('file', downsampledFile);
                sendFormData(formData);
            };
        } else {
            formData.append('file', file);
            sendFormData(formData);
        }
    }

    function sendFormData(formData) {
        let text = quill.getText();
        if (captionSize < text.length){
            alert("글은 500 자를 넘을 수 없습니다.");
            return;
        }
        formData.append('caption', text);

        let fileInput = document.getElementById("postPicInput");
        $(fileInput).val(''); //업로드한 파일 제거

        fetch('/upload/postpic', {
            method: 'POST',
            body: formData // FormData 객체
        })
            .then(response => response.text())
            .then(data => {
                console.log(data); // 서버에서 반환한 데이터 출력
                alert("데이터가 성공적으로 전달되었습니다.");
                window.location.href = 'home';
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function downsampleImage(image, maxWidth, maxHeight) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        // 이미지 크기 설정
        let width = image.width;
        let height = image.height;

        // 이미지 크기를 maxWidth 및 maxHeight에 맞게 조정
        if (width > maxWidth) {
            height *= maxWidth / width;
            width = maxWidth;
        }
        if (height > maxHeight) {
            width *= maxHeight / height;
            height = maxHeight;
        }

        // Canvas 크기 설정
        canvas.width = width;
        canvas.height = height;

        // Canvas에 이미지 그리기
        ctx.drawImage(image, 0, 0, width, height);

        return dataURLtoBlob(canvas.toDataURL('image/jpeg')); // 다운샘플링된 이미지를 Blob으로 반환
    }

    function dataURLtoBlob(dataURL) {
        const byteString = atob(dataURL.split(',')[1]);
        const mimeString = dataURL.split(',')[0].split(':')[1].split(';')[0];
        const arrayBuffer = new ArrayBuffer(byteString.length);
        const uint8Array = new Uint8Array(arrayBuffer);
        for (let i = 0; i < byteString.length; i++) {
            uint8Array[i] = byteString.charCodeAt(i);
        }
        return new Blob([arrayBuffer], { type: mimeString });
    }


</script>
</body>
</html>